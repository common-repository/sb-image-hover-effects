var getElementSettings = function($element) {
    var elementSettings = {},
        modelCID = $element.data('model-cid');

    if (isEditMode && modelCID) {
        var settings = elementorFrontend.config.elements.data[modelCID],
            settingsKeys = elementorFrontend.config.elements.keys[settings.attributes.widgetType || settings.attributes.elType];

        jQuery.each(settings.getActiveControls(), function(controlKey) {
            if (-1 !== settingsKeys.indexOf(controlKey)) {
                elementSettings[controlKey] = settings.attributes[controlKey];
            }
        });
    } else {
        elementSettings = $element.data('settings') || {};
    }

    return elementSettings;
};

var SAShowcaseHandler = function($scope, $) {
    var $carousel = $scope.find('.sa-el-showcase-preview').eq(0),
        $showcase_id = $carousel.attr('id'),
        $slider_wrap = $scope.find('.sa-el-showcase-preview-wrap'),
        $nav_wrap = $scope.find('.sa-el-showcase-navigation-items'),
        $nav = $scope.find('.sa-el-showcase .sa-el-showcase-navigation-item-wrap'),
        $video_wrap = $scope.find('.sa-el-showcase .sa-el-video-container'),
        elementSettings = getElementSettings($scope),
        $arrow_next = elementSettings.arrow,
        $arrow_prev = ($arrow_next !== undefined) ? $arrow_next.replace("right", "left") : '',
        $scrollable_nav = elementSettings.scrollable_nav,
        $preview_position = elementSettings.preview_position,
        $stack_on = elementSettings.preview_stack;

    $carousel.slick({
        slidesToShow: 1,
        slidesToScroll: 1,
        autoplay: 'yes' === elementSettings.autoplay,
        autoplaySpeed: elementSettings.autoplay_speed,
        arrows: 'yes' === elementSettings.arrows,
        prevArrow: '<div class="sa-el-slider-arrow sa-el-arrow sa-el-arrow-prev"><i class="' + $arrow_prev + '"></i></div>',
        nextArrow: '<div class="sa-el-slider-arrow sa-el-arrow sa-el-arrow-next"><i class="' + $arrow_next + '"></i></div>',
        dots: 'yes' === elementSettings.dots,
        fade: 'fade' === elementSettings.effect,
        speed: elementSettings.animation_speed,
        infinite: 'yes' === elementSettings.infinite_loop,
        pauseOnHover: 'yes' === elementSettings.pause_on_hover,
        adaptiveHeight: 'yes' === elementSettings.adaptive_height,
        rtl: 'right' === elementSettings.direction,
        asNavFor: ($scrollable_nav == 'yes') ? $nav_wrap : '',
    });

    $carousel.slick('setPosition');

    if ($scrollable_nav == 'yes') {

        $nav_wrap.slick({
            slidesToShow: (elementSettings.nav_items !== undefined && elementSettings.nav_items !== '') ? parseInt(elementSettings.nav_items) : 5,
            slidesToScroll: 1,
            asNavFor: $carousel,
            arrows: false,
            dots: false,
            infinite: 'yes' === elementSettings.infinite_loop,
            focusOnSelect: true,
            vertical: ($preview_position == 'top') ? false : true,
            centerMode: true,
            centerPadding: '0px',
            responsive: [{
                    breakpoint: 1024,
                    settings: {
                        slidesToShow: (elementSettings.nav_items_tablet !== undefined && elementSettings.nav_items_tablet !== '') ? parseInt(elementSettings.nav_items_tablet) : 3,
                        slidesToScroll: 1,
                        vertical: ($stack_on == 'tablet') ? false : true,
                    }
                },
                {
                    breakpoint: 768,
                    settings: {
                        slidesToShow: (elementSettings.nav_items_mobile !== undefined && elementSettings.nav_items_mobile !== '') ? parseInt(elementSettings.nav_items_mobile) : 2,
                        slidesToScroll: 1,
                        vertical: false,
                    }
                },
            ],
        });

    } else {

        $nav.removeClass('sa-el-active-slide');
        $nav.eq(0).addClass('sa-el-active-slide');

        $carousel.on('beforeChange', function(event, slick, currentSlide, nextSlide) {
            currentSlide = nextSlide;
            $nav.removeClass('sa-el-active-slide');
            $nav.eq(currentSlide).addClass('sa-el-active-slide');
        });

        $nav.each(function(currentSlide) {
            $(this).on('click', function(e) {
                e.preventDefault();
                $carousel.slick('slickGoTo', currentSlide);
            });
        });

    }

    if (isEditMode) {
        $slider_wrap.resize(function() {
            $carousel.slick('setPosition');
        });
    }

    var $lightbox_selector = '.slick-slide:not(.slick-cloned) .sa-el-showcase-item-link[data-fancybox="' + $showcase_id + '"]';

    $($lightbox_selector).fancybox({
        loop: true,
    });

    $video_wrap.off('click').on('click', function(e) {

        var $iframe = $("<iframe/>"),
            $vid_src = $(this).data('src'),
            $player = $(this).find('.sa-el-video-player');

        $iframe.attr('src', $vid_src);
        $iframe.attr('frameborder', '0');
        $iframe.attr('allowfullscreen', '1');
        $iframe.attr('allow', 'autoplay;encrypted-media;');

        $player.html($iframe);

    });

};
jQuery(window).on("elementor/frontend/init", function() {
    elementorFrontend.hooks.addAction(
        "frontend/element_ready/sa-el-showcase.default",
        SAShowcaseHandler
    );
});